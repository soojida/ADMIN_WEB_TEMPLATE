# PR 커밋 내역을 기반으로 릴리즈 노트 자동 생성 및 태그 발행
name: Release

on:
  push:
    branches:
      - release

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run release-please
        id: release
        uses: google-github-actions/release-please-action@v4
        with:
          release-type: simple
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Append PR titles to CHANGELOG
        if: steps.release.outputs.releases_created
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changelogPath = './CHANGELOG.md';

            let changelog = fs.readFileSync(changelogPath, 'utf8');
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 30
            });

            const prMap = new Map();
            for (const pr of pulls.data) {
              const commits = await github.paginate(
                github.rest.pulls.listCommits,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                }
              );
              for (const commit of commits) {
                prMap.set(commit.sha.substring(0, 7), {
                  number: pr.number,
                  title: pr.title
                });
              }
            }

            changelog = changelog.replace(/- .*?\((\w{7})\)/g, (match, sha) => {
              const pr = prMap.get(sha);
              if (pr) {
                return `${match}\n  🔗 PR: #${pr.number} - ${pr.title}`;
              }
              return match;
            });

            fs.writeFileSync(changelogPath, changelog, 'utf8');
