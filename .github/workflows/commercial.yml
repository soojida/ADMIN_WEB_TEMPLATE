# íƒœê·¸ ìžë™ ìƒì„± ë° ìƒìš© ë¦´ë¦¬ì¦ˆ ìƒì„± ì›Œí¬í”Œë¡œìš°
name: commercial

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # pr ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±ìš© ì „ì²´ ížˆìŠ¤í† ë¦¬

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Clean npm cache
        run: npm cache clean --force

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Create Git tag with KST timestamp (semverëŠ” ìˆ˜ë™ ë˜ëŠ” ë³„ë„ ê´€ë¦¬)
        id: create_tag
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

          YEAR=$(TZ="Asia/Seoul" date +'%Y')
          MONTH=$(TZ="Asia/Seoul" date +'%m')
          DAY=$(TZ="Asia/Seoul" date +'%d')
          HOUR=$(TZ="Asia/Seoul" date +'%H')
          MINUTE=$(TZ="Asia/Seoul" date +'%M')
          SECOND=$(TZ="Asia/Seoul" date +'%S')

          # ì—¬ê¸°ì„œ íƒœê·¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬í•˜ê±°ë‚˜ ìžë™ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥ (ì•„ëž˜ëŠ” ë‚ ì§œ ê¸°ì¤€ íƒœê·¸ ì˜ˆì‹œ)
          TAG="v${YEAR}-${MONTH}-${DAY}.${HOUR}.${MINUTE}.${SECOND}"

          echo "ðŸ“Œ íƒœê·¸ ìƒì„±: $TAG"

          git tag "$TAG"
          git push origin "$TAG"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release notes
        id: generate_notes
        run: |
          REPO_URL="https://github.com/${GITHUB_REPOSITORY}"
          CURRENT_TAG="${{ steps.create_tag.outputs.tag }}"
          PREV_TAG=$(git tag --sort=-creatordate | grep -v "$CURRENT_TAG" | head -n 1)
          echo "" > release-notes.md
          if [ -z "$PREV_TAG" ]; then
            RANGE="$CURRENT_TAG"
          else
            RANGE="$PREV_TAG..$CURRENT_TAG"
          fi
          echo ":ì±…ê°ˆí”¼: ë¦´ë¦¬ì¦ˆ ë²”ìœ„: $RANGE"
          SECTIONS=(
            "ðŸŽ‰ ìƒìš© ë°°í¬:release"
            "ðŸ› ï¸ ê¸°ëŠ¥/í™”ë©´ ê°œë°œ (ê¸°íš/ìš”ì²­ ë°˜ì˜):improve"
            "âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥:feat"
            "ðŸ”¥ ê¸´ê¸‰ ìˆ˜ì •:hotfix"
            "ðŸ› ë²„ê·¸ ìˆ˜ì •:fix"
            "ðŸ”Ž SEO ìµœì í™”:seo"
            "ðŸ§© UI/UX ê°œì„ :ui/ux"
            "ðŸŽ¨ ìŠ¤íƒ€ì¼ ìˆ˜ì •:style"
            "âš¡ ì„±ëŠ¥ ìµœì í™”:perf"
            "ðŸ§¹ ì½”ë“œ ê°œì„ :refactor"
            "ðŸ§ª í…ŒìŠ¤íŠ¸ ì¶”ê°€/ìˆ˜ì •:test"
            "ðŸ“ ë¬¸ì„œ ìž‘ì„± ë° ìˆ˜ì •:docs"
            "ðŸ”§ ê¸°íƒ€ ë³€ê²½ì‚¬í•­:chore"
            "ðŸ“¦ ë¼ì´ë¸ŒëŸ¬ë¦¬/íŒ¨í‚¤ì§€ ì¶”ê°€ ë° ì—…ë°ì´íŠ¸:deps"
            "â™»ï¸ CI/CD ìˆ˜ì •:ci"
            "âª ë³€ê²½ì‚¬í•­ ë˜ëŒë¦¬ê¸°:revert"
            "ðŸš¢ ë³‘í•©(Merge):merge"
          )
          FOUND_COMMITS=false
          for section in "${SECTIONS[@]}"; do
            TITLE="${section%%:*}"
            PREFIX="${section##*:}"
            COMMITS=$(git log $RANGE --grep="^$PREFIX:" -i --pretty=format:"%H|%s|%an" || echo "")
            if [ ! -z "$COMMITS" ]; then
              FOUND_COMMITS=true
              echo "## $TITLE" >> release-notes.md
              while IFS="|" read -r COMMIT_HASH COMMIT_MESSAGE AUTHOR_RAW; do
                AUTHOR="@$(echo "$AUTHOR_RAW" | cut -d'@' -f1)"
                SHORT_HASH=$(echo "$COMMIT_HASH" | cut -c1-7)
                echo "- $COMMIT_MESSAGE $AUTHOR [\`$SHORT_HASH\`]($REPO_URL/commit/$COMMIT_HASH)" >> release-notes.md
              done <<< "$COMMITS"
              echo "" >> release-notes.md
